@page "/appointments"
@using HIS.Application.Interfaces
@using HIS.Application.DTOs
@inject IAppointmentService AppointmentService
@inject IPatientService PatientService
@rendermode InteractiveServer

<PageTitle>Appointments</PageTitle>

<h1>Appointment Management</h1>

<div class="mb-3">
    <button class="btn btn-primary" @onclick="ShowCreateForm">
        <i class="bi bi-plus-circle"></i> Schedule New Appointment
    </button>
</div>

@if (showCreateForm)
{
    <div class="card mb-3">
        <div class="card-header">
            <h5>@(isEditing ? "Edit Appointment" : "Schedule New Appointment")</h5>
        </div>
        <div class="card-body">
            <EditForm Model="@appointmentDto" OnValidSubmit="HandleSubmit">
                <div class="mb-3">
                    <label class="form-label">Patient</label>
                    <InputSelect class="form-control" @bind-Value="appointmentDto.PatientId">
                        <option value="">Select Patient</option>
                        @foreach (var patient in patients)
                        {
                            <option value="@patient.Id">@patient.FirstName @patient.LastName (@patient.MedicalRecordNumber)</option>
                        }
                    </InputSelect>
                </div>
                <div class="mb-3">
                    <label class="form-label">Doctor Name</label>
                    <InputText class="form-control" @bind-Value="appointmentDto.DoctorName" />
                </div>
                <div class="mb-3">
                    <label class="form-label">Appointment Date & Time</label>
                    <InputDate Type="InputDateType.DateTimeLocal" class="form-control" @bind-Value="appointmentDto.AppointmentDate" />
                </div>
                <div class="mb-3">
                    <label class="form-label">Reason</label>
                    <InputText class="form-control" @bind-Value="appointmentDto.Reason" />
                </div>
                <div class="mb-3">
                    <label class="form-label">Notes</label>
                    <InputTextArea class="form-control" @bind-Value="appointmentDto.Notes" rows="3" />
                </div>
                <div>
                    <button type="submit" class="btn btn-success">@(isEditing ? "Update" : "Schedule")</button>
                    <button type="button" class="btn btn-secondary" @onclick="CancelForm">Cancel</button>
                </div>
            </EditForm>
        </div>
    </div>
}

@if (loading)
{
    <p><em>Loading appointments...</em></p>
}
else if (appointments.Any())
{
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>Patient</th>
                    <th>Doctor</th>
                    <th>Date & Time</th>
                    <th>Status</th>
                    <th>Reason</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var appointment in appointments.OrderBy(a => a.AppointmentDate))
                {
                    <tr>
                        <td>@appointment.PatientName</td>
                        <td>@appointment.DoctorName</td>
                        <td>@appointment.AppointmentDate.ToString("g")</td>
                        <td>
                            <span class="badge bg-@GetStatusBadgeColor(appointment.Status)">
                                @appointment.Status
                            </span>
                        </td>
                        <td>@appointment.Reason</td>
                        <td>
                            <button class="btn btn-sm btn-warning" @onclick="() => EditAppointment(appointment)">Edit</button>
                            <button class="btn btn-sm btn-danger" @onclick="() => DeleteAppointment(appointment.Id)">Delete</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}
else
{
    <p><em>No appointments scheduled.</em></p>
}

@code {
    private List<AppointmentDto> appointments = new();
    private List<PatientDto> patients = new();
    private CreateAppointmentDto appointmentDto = new();
    private bool loading = true;
    private bool showCreateForm = false;
    private bool isEditing = false;
    private Guid? editingAppointmentId;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        loading = true;
        var appointmentsTask = AppointmentService.GetAllAppointmentsAsync();
        var patientsTask = PatientService.GetAllPatientsAsync();
        
        await Task.WhenAll(appointmentsTask, patientsTask);
        
        appointments = (await appointmentsTask).ToList();
        patients = (await patientsTask).ToList();
        loading = false;
    }

    private void ShowCreateForm()
    {
        appointmentDto = new CreateAppointmentDto
        {
            AppointmentDate = DateTime.Now.AddDays(1)
        };
        isEditing = false;
        editingAppointmentId = null;
        showCreateForm = true;
    }

    private async Task EditAppointment(AppointmentDto appointment)
    {
        appointmentDto = new CreateAppointmentDto
        {
            PatientId = appointment.PatientId,
            DoctorName = appointment.DoctorName,
            AppointmentDate = appointment.AppointmentDate,
            Reason = appointment.Reason,
            Notes = appointment.Notes
        };
        isEditing = true;
        editingAppointmentId = appointment.Id;
        showCreateForm = true;
    }

    private async Task HandleSubmit()
    {
        try
        {
            if (isEditing && editingAppointmentId.HasValue)
            {
                await AppointmentService.UpdateAppointmentAsync(editingAppointmentId.Value, appointmentDto);
            }
            else
            {
                await AppointmentService.CreateAppointmentAsync(appointmentDto);
            }

            await LoadData();
            CancelForm();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
        }
    }

    private void CancelForm()
    {
        showCreateForm = false;
        appointmentDto = new CreateAppointmentDto();
        isEditing = false;
        editingAppointmentId = null;
    }

    private async Task DeleteAppointment(Guid id)
    {
        await AppointmentService.DeleteAppointmentAsync(id);
        await LoadData();
    }

    private string GetStatusBadgeColor(string status)
    {
        return status switch
        {
            "Scheduled" => "primary",
            "Completed" => "success",
            "Cancelled" => "danger",
            _ => "secondary"
        };
    }
}
