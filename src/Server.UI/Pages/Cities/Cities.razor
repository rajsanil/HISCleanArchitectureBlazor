@page "/pages/cities"
@using CleanArchitecture.Blazor.Application.Features.Cities.DTOs
@using CleanArchitecture.Blazor.Application.Features.Cities.Queries.GetAll
@using CleanArchitecture.Blazor.Application.Features.Cities.Commands.AddEdit
@using CleanArchitecture.Blazor.Application.Features.Cities.Commands.Delete
@using CleanArchitecture.Blazor.Application.Features.Cities.Caching
@using CleanArchitecture.Blazor.Application.Features.Cities.Mappers
@using CleanArchitecture.Blazor.Application.Features.Countries.DTOs
@using CleanArchitecture.Blazor.Application.Features.Countries.Queries.GetAll
@using CleanArchitecture.Blazor.Server.UI.Pages.Cities.Components

@inject IStringLocalizer<Cities> L
@attribute [Authorize(Policy = Permissions.Cities.View)]

<PageTitle>@L["Cities"]</PageTitle>

<MudPaper Elevation="0" Class="pa-4">
    <TelerikGrid Data="@_cities"
                 FilterMode="GridFilterMode.FilterMenu"
                 Sortable="true"
                 Pageable="true"
                 PageSize="15"
                 Resizable="true"
                 Reorderable="true"
                 SelectionMode="GridSelectionMode.Single"
                 @bind-SelectedItems="@_selectedItems"
                 Height="calc(100vh - 300px)">
        <GridToolBarTemplate>
            <MudStack Row Spacing="2" Class="flex-grow-1" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                <MudStack Row AlignItems="AlignItems.Center">
                    <MudIcon Icon="@Icons.Material.Filled.LocationCity" Size="Size.Large" Color="Color.Info" />
                    <MudStack Spacing="0">
                        <MudText Typo="Typo.h6">@L["Cities"]</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">@L["Manage cities"]</MudText>
                    </MudStack>
                </MudStack>
                <MudStack Row Spacing="1">
                    <MudButton Disabled="@_loading"
                               OnClick="@OnRefresh"
                               StartIcon="@Icons.Material.Outlined.Refresh"
                               Variant="Variant.Text">
                        @ConstantString.Refresh
                    </MudButton>
                    @if (_canCreate)
                    {
                        <MudButton StartIcon="@Icons.Material.Outlined.Add"
                                   OnClick="OnCreate"
                                   Color="Color.Primary"
                                   Variant="Variant.Filled">
                            @ConstantString.New
                        </MudButton>
                    }
                </MudStack>
            </MudStack>
        </GridToolBarTemplate>
        <GridColumns>
            <GridColumn Width="100px" Title="@ConstantString.Actions" Sortable="false" Filterable="false">
                <Template>
                    @{
                        var item = context as CityDto;
                        @if (_canEdit || _canDelete)
                        {
                            <MudStack Row Spacing="1">
                                @if (_canEdit)
                                {
                                    <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                                 Size="Size.Small" 
                                                 Color="Color.Info"
                                                 OnClick="@(() => OnEdit(item!))" />
                                }
                                @if (_canDelete)
                                {
                                    <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                                 Size="Size.Small" 
                                                 Color="Color.Error"
                                                 OnClick="@(() => OnDelete(item!))" />
                                }
                            </MudStack>
                        }
                        else
                        {
                            <MudIconButton Variant="Variant.Filled"
                                         Disabled="true"
                                         Icon="@Icons.Material.Filled.DoNotTouch"
                                         Size="Size.Small"
                                         Color="Color.Surface">
                            </MudIconButton>
                        }
                    }
                </Template>
            </GridColumn>
            <GridColumn Field="@nameof(CityDto.Code)" Title="@L["Code"]" Width="120px" />
            <GridColumn Field="@nameof(CityDto.Name)" Title="@L["Name"]" />
            <GridColumn Field="@nameof(CityDto.NameArabic)" Title="@L["Name (Arabic)"]" />
            <GridColumn Field="@nameof(CityDto.CountryId)" Title="@L["Country"]" Width="200px">
                <Template>
                    @{
                        var item = context as CityDto;
                        var country = _countries.FirstOrDefault(c => c.Id == item?.CountryId);
                        <MudText>@(country?.Name ?? string.Empty)</MudText>
                    }
                </Template>
            </GridColumn>
            <GridColumn Field="@nameof(CityDto.IsActive)" Title="@L["Active"]" Width="100px">
                <Template>
                    @{
                        var item = context as CityDto;
                        <MudCheckBox T="bool" Value="@(item?.IsActive ?? false)" ReadOnly="true" Color="Color.Primary" />
                    }
                </Template>
            </GridColumn>
        </GridColumns>
    </TelerikGrid>
</MudPaper>

@code {
    [CascadingParameter] private Task<AuthenticationState> AuthState { get; set; } = default!;
    
    private IEnumerable<CityDto> _cities = new List<CityDto>();
    private IEnumerable<CountryDto> _countries = new List<CountryDto>();
    private IEnumerable<CityDto> _selectedItems = new List<CityDto>();
    private bool _loading;
    private bool _canCreate;
    private bool _canEdit;
    private bool _canDelete;
    private bool _canSearch;
    private bool _canExport;
    private bool _canImport;

    protected override async Task OnInitializedAsync()
    {
        var state = await AuthState;
        _canCreate = (await AuthService.AuthorizeAsync(state.User, Permissions.Cities.Create)).Succeeded;
        _canSearch = (await AuthService.AuthorizeAsync(state.User, Permissions.Cities.Search)).Succeeded;
        _canEdit = (await AuthService.AuthorizeAsync(state.User, Permissions.Cities.Edit)).Succeeded;
        _canDelete = (await AuthService.AuthorizeAsync(state.User, Permissions.Cities.Delete)).Succeeded;
        _canImport = (await AuthService.AuthorizeAsync(state.User, Permissions.Cities.Import)).Succeeded;
        _canExport = (await AuthService.AuthorizeAsync(state.User, Permissions.Cities.Export)).Succeeded;
        await LoadData();
    }

    private async Task LoadData()
    {
        _loading = true;
        try
        {
            // Load countries first for lookups
            _countries = await Mediator.Send(new GetAllCountriesQuery());
            // Then load cities
            _cities = await Mediator.Send(new GetAllCitiesQuery());
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task OnRefresh()
    {
        CityCacheKey.Refresh();
        await LoadData();
    }

    private async Task OnCreate()
    {
        var command = new AddEditCityCommand();
        await ShowEditFormDialog(string.Format(ConstantString.CreateAnItem, L["City"]), command);
    }

    private async Task OnEdit(CityDto dto)
    {
        var command = CityMapper.CloneFromDto(dto);
        await ShowEditFormDialog(string.Format(ConstantString.EditTheItem, L["City"]), command);
    }

    private async Task OnDelete(CityDto dto)
    {
        var contentText = string.Format(ConstantString.DeleteConfirmation, dto.Name);
        var command = new DeleteCityCommand(new int[] { dto.Id });
        await DialogServiceHelper.ShowDeleteConfirmationDialogAsync(command, ConstantString.DeleteConfirmationTitle, contentText, async () =>
        {
            await InvokeAsync(async () =>
            {
                await LoadData();
            });
        });
    }

    private async Task ShowEditFormDialog(string title, AddEditCityCommand command)
    {
        var parameters = new DialogParameters<CityFormDialog>
        {
            { x => x.Model, command },
            { x => x.Countries, _countries }
        };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = await DialogService.ShowAsync<CityFormDialog>(title, parameters, options);
        var state = await dialog.Result;

        if (state != null && !state.Canceled)
        {
            await LoadData();
        }
    }
}

