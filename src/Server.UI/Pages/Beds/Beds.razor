@page "/pages/beds"
@using CleanArchitecture.Blazor.Application.Features.Beds.DTOs
@using CleanArchitecture.Blazor.Application.Features.Beds.Mappers
@using CleanArchitecture.Blazor.Application.Features.Beds.Queries.GetAll
@using CleanArchitecture.Blazor.Application.Features.Beds.Caching
@using CleanArchitecture.Blazor.Application.Features.Beds.Commands.AddEdit
@using CleanArchitecture.Blazor.Application.Features.Beds.Commands.Delete
@using CleanArchitecture.Blazor.Application.Features.Beds.Commands.UpdateStatus
@using CleanArchitecture.Blazor.Application.Features.Rooms.DTOs
@using CleanArchitecture.Blazor.Application.Features.Rooms.Queries.GetAll
@using CleanArchitecture.Blazor.Server.UI.Pages.Beds.Components
@using Telerik.Blazor.Components

@attribute [Authorize(Policy = Permissions.Beds.View)]
@inject IStringLocalizer<Beds> L
@inject IValidationService Validator

<PageTitle>@Title</PageTitle>

<MudStack Spacing="0" Class="flex-grow-1">
    <MudStack Row Spacing="2" Class="align-center mb-2">
        <MudIcon Icon="@Icons.Material.Filled.Bed" Size="Size.Large" />
        <MudText Typo="Typo.h6">@L[_currentDto.GetClassDescription()]</MudText>
        <MudSpacer />
        <MudButton Disabled="@_loading"
                   OnClick="@(() => OnRefresh())"
                   StartIcon="@Icons.Material.Outlined.Refresh"
                   Variant="Variant.Outlined">
            @ConstantString.Refresh
        </MudButton>
        @if (_canCreate)
        {
            <MudButton StartIcon="@Icons.Material.Outlined.Add"
                       OnClick="OnCreate"
                       Color="Color.Primary"
                       Variant="Variant.Filled">
                @ConstantString.New
            </MudButton>
        }
        @if (_canDelete && _selectedItems.Any())
        {
            <MudButton StartIcon="@Icons.Material.Outlined.Delete"
                       OnClick="OnDeleteChecked"
                       Color="Color.Error"
                       Variant="Variant.Filled">
                @ConstantString.Delete (@_selectedItems.Count())
            </MudButton>
        }
    </MudStack>

    <TelerikGrid Data="@_items"
                 Pageable="true"
                 PageSize="20"
                 Sortable="true"
                 FilterMode="GridFilterMode.FilterRow"
                 SelectionMode="GridSelectionMode.Multiple"
                 @bind-SelectedItems="_selectedItems"
                 Height="calc(100vh - 280px)">
        <GridColumns>
            <GridCheckboxColumn SelectAll="true" Width="60px" />
            <GridColumn Field="@nameof(BedDto.Code)" Title="@L["Code"]" Width="150px" />
            <GridColumn Field="@nameof(BedDto.RoomId)" Title="@L["Room ID"]" Width="120px" />
            <GridColumn Field="@nameof(BedDto.BedStatus)" Title="@L["Status"]" Width="150px">
                <Template>
                    @{
                        var bed = (BedDto)context;
                        <MudChip T="string" Size="Size.Small" Color="@GetBedStatusColor(bed.BedStatus)">
                            @bed.BedStatus
                        </MudChip>
                    }
                </Template>
            </GridColumn>
            <GridColumn Field="@nameof(BedDto.IsActive)" Title="@L["Active"]" Width="100px">
                <Template>
                    @{
                        var bed = (BedDto)context;
                        <MudCheckBox T="bool" Checked="@bed.IsActive" ReadOnly="true" Size="Size.Small" />
                    }
                </Template>
            </GridColumn>
            <GridColumn Width="120px" Title="@ConstantString.Actions" Sortable="false" Filterable="false">
                <Template>
                    @{
                        var bed = (BedDto)context;
                        <MudStack Row Spacing="1">
                            @if (_canEdit)
                            {
                                <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                               Size="Size.Small"
                                               Color="Color.Primary"
                                               OnClick="@(() => OnEdit(bed))" />
                            }
                            @if (_canManageStatus)
                            {
                                <MudIconButton Icon="@Icons.Material.Filled.SwapHoriz"
                                               Size="Size.Small"
                                               Color="Color.Info"
                                               OnClick="@(() => OnChangeStatus(bed))" />
                            }
                            @if (_canDelete)
                            {
                                <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                               Size="Size.Small"
                                               Color="Color.Error"
                                               OnClick="@(() => OnDelete(bed))" />
                            }
                        </MudStack>
                    }
                </Template>
            </GridColumn>
        </GridColumns>
    </TelerikGrid>
</MudStack>

<TelerikWindow @bind-Visible="_formVisible"
               Modal="true"
               Width="900px">
    <WindowTitle>@_formTitle</WindowTitle>
    <WindowContent>
        @if (_editModel is not null)
        {
            <MudForm @ref="_form" Model="@_editModel" Validation="@(Validator.ValidateValue(_editModel))">
                <MudGrid Spacing="3" Class="pa-2">
                    <MudItem xs="12" sm="6">
                        <MudTextField Label="@L["Code"]"
                                      @bind-Value="_editModel.Code"
                                      Required="true"
                                      Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudSelect T="int"
                                   Label="@L["Room"]"
                                   @bind-Value="_editModel.RoomId"
                                   Required="true"
                                   Variant="Variant.Outlined"
                                   AnchorOrigin="Origin.BottomCenter">
                            @foreach (var room in _rooms)
                            {
                                <MudSelectItem T="int" Value="@room.Id">@room.Name</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudSelect T="string"
                                   Label="@L["Bed Status"]"
                                   @bind-Value="_editModel.BedStatus"
                                   Required="true"
                                   Variant="Variant.Outlined"
                                   AnchorOrigin="Origin.BottomCenter">
                            <MudSelectItem T="string" Value="@("Available")">@L["Available"]</MudSelectItem>
                            <MudSelectItem T="string" Value="@("Occupied")">@L["Occupied"]</MudSelectItem>
                            <MudSelectItem T="string" Value="@("Cleaning")">@L["Cleaning"]</MudSelectItem>
                            <MudSelectItem T="string" Value="@("Maintenance")">@L["Maintenance"]</MudSelectItem>
                            <MudSelectItem T="string" Value="@("Reserved")">@L["Reserved"]</MudSelectItem>
                            <MudSelectItem T="string" Value="@("Blocked")">@L["Blocked"]</MudSelectItem>
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="12" sm="6" Class="d-flex align-center">
                        <MudCheckBox Label="@L["Is Active"]"
                                     @bind-Value="_editModel.IsActive"
                                     Color="Color.Primary" />
                    </MudItem>
                </MudGrid>
            </MudForm>

            <MudStack Row Spacing="2" Justify="Justify.FlexEnd" Class="pa-2 mt-2">
                <MudButton Variant="Variant.Text"
                           Color="Color.Default"
                           OnClick="CloseForm">
                    @ConstantString.Cancel
                </MudButton>
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           OnClick="SaveForm">
                    @ConstantString.Save
                </MudButton>
            </MudStack>
        }
    </WindowContent>
</TelerikWindow>

@code {
    [CascadingParameter] private Task<AuthenticationState> AuthState { get; set; } = default!;
    [CascadingParameter] private UserProfile? UserProfile { get; set; }
    public string? Title { get; private set; }
    private IEnumerable<BedDto> _selectedItems = new List<BedDto>();
    private BedDto _currentDto = new();
    private bool _loading;
    private List<BedDto> _items = new();
    private bool _canCreate;
    private bool _canEdit;
    private bool _canDelete;
    private bool _canManageStatus;

    // Form state
    private bool _formVisible = false;
    private string _formTitle = string.Empty;
    private AddEditBedCommand? _editModel;
    private MudForm? _form;
    private List<RoomDto> _rooms = new();

    protected override async Task OnInitializedAsync()
    {
        Title = L[_currentDto.GetClassDescription()];
        var state = await AuthState;
        _canCreate = (await AuthService.AuthorizeAsync(state.User, Permissions.Beds.Create)).Succeeded;
        _canEdit = (await AuthService.AuthorizeAsync(state.User, Permissions.Beds.Edit)).Succeeded;
        _canDelete = (await AuthService.AuthorizeAsync(state.User, Permissions.Beds.Delete)).Succeeded;
        _canManageStatus = (await AuthService.AuthorizeAsync(state.User, Permissions.Beds.ManageStatus)).Succeeded;
        await LoadData();
        await LoadLookupData();
    }

    private async Task LoadData()
    {
        _loading = true;
        try
        {
            var result = await Mediator.Send(new GetAllBedsQuery());
            _items = result.ToList();
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task LoadLookupData()
    {
        _rooms = (await Mediator.Send(new GetAllRoomsQuery())).ToList();
    }

    private Color GetBedStatusColor(string status) => status switch
    {
        "Available" => Color.Success,
        "Occupied" => Color.Error,
        "Cleaning" => Color.Warning,
        "Maintenance" => Color.Default,
        "Reserved" => Color.Info,
        "Blocked" => Color.Dark,
        _ => Color.Default
    };

    private async Task OnRefresh()
    {
        BedCacheKey.Refresh();
        _selectedItems = new List<BedDto>();
        await LoadData();
    }

    private async Task OnChangeStatus(BedDto dto)
    {
        var parameters = new DialogParameters<BedStatusDialog>
        {
            { x => x.BedId, dto.Id },
            { x => x.CurrentStatus, dto.BedStatus }
        };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<BedStatusDialog>("Change Bed Status", parameters, options);
        var state = await dialog.Result;

        if (state is not null && !state.Canceled)
        {
            await LoadData();
        }
    }

    private void OnCreate()
    {
        _editModel = new AddEditBedCommand();
        _formTitle = string.Format(ConstantString.CreateAnItem, L["Bed"]);
        _formVisible = true;
    }

    private void OnEdit(BedDto dto)
    {
        _editModel = BedMapper.ToEditCommand(dto);
        _formTitle = string.Format(ConstantString.EditTheItem, L["Bed"]);
        _formVisible = true;
    }

    private void CloseForm()
    {
        _formVisible = false;
        _editModel = null;
    }

    private async Task SaveForm()
    {
        if (_form != null)
        {
            await _form.Validate();
            if (_form.IsValid && _editModel != null)
            {
                var result = await Mediator.Send(_editModel);
                if (result.Succeeded)
                {
                    Snackbar.Add(ConstantString.SaveSuccess, Severity.Success);
                    CloseForm();
                    await LoadData();
                    _selectedItems = new List<BedDto>();
                }
                else
                {
                    Snackbar.Add(result.ErrorMessage, Severity.Error);
                }
            }
        }
    }

    private async Task OnDelete(BedDto dto)
    {
        var contentText = string.Format(ConstantString.DeleteConfirmation, dto.Code);
        var command = new DeleteBedCommand(new[] { dto.Id });
        await DialogServiceHelper.ShowDeleteConfirmationDialogAsync(command, ConstantString.DeleteConfirmationTitle, contentText, async () =>
        {
            await InvokeAsync(async () =>
            {
                await LoadData();
                _selectedItems = new List<BedDto>();
            });
        });
    }

    private async Task OnDeleteChecked()
    {
        var contentText = string.Format(ConstantString.DeleteConfirmWithSelected, _selectedItems.Count());
        var command = new DeleteBedCommand(_selectedItems.Select(x => x.Id).ToArray());
        await DialogServiceHelper.ShowDeleteConfirmationDialogAsync(command, ConstantString.DeleteConfirmationTitle, contentText, async () =>
        {
            await InvokeAsync(async () =>
            {
                await LoadData();
                _selectedItems = new List<BedDto>();
            });
        });
    }
}