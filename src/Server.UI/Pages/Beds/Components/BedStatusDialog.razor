@using CleanArchitecture.Blazor.Application.Features.Beds.Commands.UpdateStatus
@inject IStringLocalizer<Beds> L

<MudDialog>
    <DialogContent>
        <MudSelect T="string" Label="@L["New Status"]" @bind-Value="_newStatus" Required="true">
            <MudSelectItem Value="@("Available")">Available</MudSelectItem>
            <MudSelectItem Value="@("Occupied")">Occupied</MudSelectItem>
            <MudSelectItem Value="@("Maintenance")">Maintenance</MudSelectItem>
            <MudSelectItem Value="@("Cleaning")">Cleaning</MudSelectItem>
            <MudSelectItem Value="@("Reserved")">Reserved</MudSelectItem>
            <MudSelectItem Value="@("Blocked")">Blocked</MudSelectItem>
        </MudSelect>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">@ConstantString.Cancel</MudButton>
        <MudLoadingButton Loading="@_saving" OnClick="Submit">@ConstantString.Save</MudLoadingButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] private IMudDialogInstance MudDialog { get; set; } = default!;
    [EditorRequired][Parameter] public int BedId { get; set; }
    [Parameter] public string CurrentStatus { get; set; } = "Available";
    private string _newStatus = "Available";
    private bool _saving;

    protected override void OnInitialized()
    {
        _newStatus = CurrentStatus;
    }

    private async Task Submit()
    {
        _saving = true;
        try
        {
            var command = new UpdateBedStatusCommand { BedId = BedId, NewStatus = _newStatus };
            var result = await Mediator.Send(command);
            result.Match(
                data =>
                {
                    MudDialog.Close(DialogResult.Ok(true));
                    Snackbar.Add(ConstantString.SaveSuccess, Severity.Info);
                    return data;
                },
                errors =>
                {
                    Snackbar.Add(errors, Severity.Error);
                    return 0;
                });
        }
        finally
        {
            _saving = false;
        }
    }

    private void Cancel() => MudDialog.Cancel();
}
