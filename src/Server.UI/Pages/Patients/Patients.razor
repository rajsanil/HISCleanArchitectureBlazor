@page "/pages/patients"
@using CleanArchitecture.Blazor.Application.Features.Patients.DTOs
@using CleanArchitecture.Blazor.Application.Features.Patients.Queries.GetAll
@using CleanArchitecture.Blazor.Application.Features.Patients.Caching
@using CleanArchitecture.Blazor.Application.Features.Patients.Commands.Delete

@attribute [Authorize(Policy = Permissions.Patients.View)]
@inject IStringLocalizer<Patients> L
@inject NavigationManager Navigation

<PageTitle>@Title</PageTitle>

<MudPaper Elevation="0" Class="pa-4">
    @* ── Header Toolbar ── *@
    <MudStack Row Spacing="0" Class="mb-3" Justify="Justify.SpaceBetween">
        <MudStack Row AlignItems="AlignItems.Center">
            <MudIcon Icon="@Icons.Material.Filled.People" Size="Size.Large" Color="Color.Primary" />
            <MudStack Spacing="0">
                <MudText Typo="Typo.h6">@Title</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">@L["Manage patient records"]</MudText>
            </MudStack>
        </MudStack>
        <MudStack Row Spacing="1" AlignItems="AlignItems.Center" Class="flex-wrap">
            @if (_canSearch)
            {
                <MudTextField T="string"
                              Value="@_searchString"
                              ValueChanged="@OnSearch"
                              Placeholder="@ConstantString.Search"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Search"
                              IconSize="Size.Small"
                              Class="mt-0"
                              Style="min-width:200px;" />
            }
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Default"
                       StartIcon="@Icons.Material.Outlined.Refresh"
                       OnClick="OnRefresh"
                       Disabled="@_loading">
                @ConstantString.Refresh
            </MudButton>
            @if (_canCreate)
            {
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           StartIcon="@Icons.Material.Outlined.Add"
                           OnClick="OnCreate">
                    @ConstantString.New
                </MudButton>
            }
            @if (_canCreate)
            {
                <MudButton Variant="Variant.Outlined"
                           Color="Color.Primary"
                           StartIcon="@Icons.Material.Outlined.ContentCopy"
                           OnClick="OnClone"
                           Disabled="@(_selectedItems?.Count() != 1)">
                    @ConstantString.Clone
                </MudButton>
            }
            @if (_canDelete)
            {
                <MudButton Variant="Variant.Outlined"
                           Color="Color.Error"
                           StartIcon="@Icons.Material.Outlined.Delete"
                           OnClick="OnDeleteChecked"
                           Disabled="@(!(_selectedItems?.Any() ?? false))">
                    @ConstantString.Delete (@(_selectedItems?.Count() ?? 0))
                </MudButton>
            }
        </MudStack>
    </MudStack>

    @* ── Telerik Data Grid ── *@
    <div class="telerik-grid-container">
        <TelerikGrid Data="@_filteredItems"
                     Pageable="true"
                     PageSize="@_pageSize"
                     @bind-Page="@_currentPage"
                     Sortable="true"
                     SortMode="@Telerik.Blazor.SortMode.Multiple"
                     FilterMode="@GridFilterMode.FilterRow"
                     Resizable="true"
                     Reorderable="true"
                     SelectionMode="@GridSelectionMode.Multiple"
                     @bind-SelectedItems="@_selectedItems"
                     Height="calc(100vh - 340px)"
                     OnRowDoubleClick="@OnRowDoubleClick">
            <GridColumns>
                <GridCheckboxColumn Width="50px" SelectAll="true" />
                <GridColumn Field="@nameof(PatientDto.MRN)"
                            Title="@L["MRN"]"
                            Width="130px" />
                <GridColumn Field="@nameof(PatientDto.FirstName)"
                            Title="@L["First Name"]"
                            Width="150px" />
                <GridColumn Field="@nameof(PatientDto.LastName)"
                            Title="@L["Last Name"]"
                            Width="150px" />
                <GridColumn Field="@nameof(PatientDto.Gender)"
                            Title="@L["Gender"]"
                            Width="100px" />
                <GridColumn Field="@nameof(PatientDto.DateOfBirth)"
                            Title="@L["Date of Birth"]"
                            Width="130px">
                    <Template>
                        @{
                            var item = (PatientDto)context;
                        }
                        <span>@item.DateOfBirth.ToString("dd/MM/yyyy")</span>
                    </Template>
                </GridColumn>
                <GridColumn Field="@nameof(PatientDto.EmiratesId)"
                            Title="@L["Emirates ID"]"
                            Width="160px" />
                <GridColumn Field="@nameof(PatientDto.Phone)"
                            Title="@L["Phone"]"
                            Width="140px" />
                <GridColumn Field="@nameof(PatientDto.IsVIP)"
                            Title="@L["VIP"]"
                            Width="100px"
                            TextAlign="@ColumnTextAlign.Center">
                    <Template>
                        @{
                            var item = (PatientDto)context;
                        }
                        @if (item.IsVIP)
                        {
                            <MudChip T="string" Size="Size.Small"
                                     Color="Color.Warning"
                                     Variant="Variant.Filled">
                                VIP
                            </MudChip>
                        }
                    </Template>
                </GridColumn>
                <GridColumn Field="@nameof(PatientDto.IsActive)"
                            Title="@L["Active"]"
                            Width="110px"
                            TextAlign="@ColumnTextAlign.Center">
                    <Template>
                        @{
                            var item = (PatientDto)context;
                        }
                        <MudChip T="string" Size="Size.Small"
                                 Color="@(item.IsActive ? Color.Success : Color.Default)"
                                 Variant="Variant.Filled">
                            @(item.IsActive ? L["Active"] : L["Inactive"])
                        </MudChip>
                    </Template>
                </GridColumn>
                <GridColumn Title="@ConstantString.Actions"
                            Width="120px"
                            Filterable="false"
                            Sortable="false"
                            TextAlign="@ColumnTextAlign.Center">
                    <Template>
                        @{
                            var item = (PatientDto)context;
                        }
                        @if (_canEdit)
                        {
                            <MudIconButton Icon="@Icons.Material.Outlined.Edit"
                                           Size="Size.Small"
                                           Color="Color.Primary"
                                           OnClick="@(() => OnEdit(item))"
                                           Title="@ConstantString.Edit" />
                        }
                        @if (_canDelete)
                        {
                            <MudIconButton Icon="@Icons.Material.Outlined.Delete"
                                           Size="Size.Small"
                                           Color="Color.Error"
                                           OnClick="@(() => OnDelete(item))"
                                           Title="@ConstantString.Delete" />
                        }
                    </Template>
                </GridColumn>
            </GridColumns>
        </TelerikGrid>
    </div>
</MudPaper>

@code {
    [CascadingParameter] private Task<AuthenticationState> AuthState { get; set; } = default!;
    [CascadingParameter] private UserProfile? UserProfile { get; set; }

    // ── Grid state ──
    public string? Title { get; private set; }
    private List<PatientDto> _allPatients = new();
    private List<PatientDto> _filteredItems = new();
    private IEnumerable<PatientDto> _selectedItems { get; set; } = new List<PatientDto>();
    private bool _loading;
    private int _pageSize = 15;
    private int _currentPage = 1;
    private string _searchString = string.Empty;

    // ── Permissions ──
    private bool _canSearch;
    private bool _canCreate;
    private bool _canEdit;
    private bool _canDelete;

    protected override async Task OnInitializedAsync()
    {
        Title = L["Patients"];
        var state = await AuthState;
        _canCreate = (await AuthService.AuthorizeAsync(state.User, Permissions.Patients.Create)).Succeeded;
        _canSearch = (await AuthService.AuthorizeAsync(state.User, Permissions.Patients.Search)).Succeeded;
        _canEdit = (await AuthService.AuthorizeAsync(state.User, Permissions.Patients.Edit)).Succeeded;
        _canDelete = (await AuthService.AuthorizeAsync(state.User, Permissions.Patients.Delete)).Succeeded;

        await LoadData();
    }

    private async Task LoadData()
    {
        _loading = true;
        try
        {
            var result = await Mediator.Send(new GetAllPatientsQuery());
            _allPatients = result.ToList();
            ApplySearch();
        }
        finally
        {
            _loading = false;
        }
    }

    private void ApplySearch()
    {
        _filteredItems = string.IsNullOrWhiteSpace(_searchString)
            ? _allPatients.ToList()
            : _allPatients.Where(x =>
                (x.MRN?.Contains(_searchString, StringComparison.OrdinalIgnoreCase) ?? false) ||
                x.FirstName.Contains(_searchString, StringComparison.OrdinalIgnoreCase) ||
                x.LastName.Contains(_searchString, StringComparison.OrdinalIgnoreCase) ||
                (x.EmiratesId?.Contains(_searchString, StringComparison.OrdinalIgnoreCase) ?? false) ||
                (x.Phone?.Contains(_searchString, StringComparison.OrdinalIgnoreCase) ?? false)
            ).ToList();
    }

    private void OnSearch(string text)
    {
        _searchString = text;
        ApplySearch();
    }

    private async Task OnRefresh()
    {
        PatientCacheKey.Refresh();
        _selectedItems = new List<PatientDto>();
        _searchString = string.Empty;
        await LoadData();
    }

    private void OnRowDoubleClick(GridRowClickEventArgs args)
    {
        if (_canEdit && args.Item is PatientDto dto)
        {
            Navigation.NavigateTo($"/pages/patients/edit/{dto.Id}");
        }
    }

    // ── CRUD Operations ──

    private void OnCreate()
    {
        Navigation.NavigateTo("/pages/patients/new");
    }

    private void OnClone()
    {
        var copy = _selectedItems.FirstOrDefault();
        if (copy is null) return;
        Navigation.NavigateTo($"/pages/patients/edit/{copy.Id}");
    }

    private void OnEdit(PatientDto dto)
    {
        Navigation.NavigateTo($"/pages/patients/edit/{dto.Id}");
    }

    private async Task OnDelete(PatientDto dto)
    {
        var contentText = string.Format(ConstantString.DeleteConfirmation, $"{dto.FirstName} {dto.LastName}");
        var command = new DeletePatientCommand(new[] { dto.Id });
        await DialogServiceHelper.ShowDeleteConfirmationDialogAsync(command, ConstantString.DeleteConfirmationTitle, contentText, async () =>
        {
            await InvokeAsync(async () =>
            {
                await LoadData();
                _selectedItems = new List<PatientDto>();
            });
        });
    }

    private async Task OnDeleteChecked()
    {
        var selected = _selectedItems.ToList();
        if (!selected.Any()) return;
        var contentText = string.Format(ConstantString.DeleteConfirmWithSelected, selected.Count);
        var command = new DeletePatientCommand(selected.Select(x => x.Id).ToArray());
        await DialogServiceHelper.ShowDeleteConfirmationDialogAsync(command, ConstantString.DeleteConfirmationTitle, contentText, async () =>
        {
            await InvokeAsync(async () =>
            {
                await LoadData();
                _selectedItems = new List<PatientDto>();
            });
        });
    }
}
