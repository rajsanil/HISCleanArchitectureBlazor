@using CleanArchitecture.Blazor.Application.Features.Patients.Commands.AddEdit
@using CleanArchitecture.Blazor.Application.Features.BloodGroups.DTOs
@using CleanArchitecture.Blazor.Application.Features.BloodGroups.Queries.GetAll
@using CleanArchitecture.Blazor.Application.Features.MaritalStatuses.DTOs
@using CleanArchitecture.Blazor.Application.Features.MaritalStatuses.Queries.GetAll
@using CleanArchitecture.Blazor.Application.Features.Nationalities.DTOs
@using CleanArchitecture.Blazor.Application.Features.Nationalities.Queries.GetAll
@using CleanArchitecture.Blazor.Application.Features.Cities.DTOs
@using CleanArchitecture.Blazor.Application.Features.Cities.Queries.GetAll
@using CleanArchitecture.Blazor.Application.Features.Countries.DTOs
@using CleanArchitecture.Blazor.Application.Features.Countries.Queries.GetAll
@using CleanArchitecture.Blazor.Domain.Common.Enums
@inject IStringLocalizer<Patients> L

<MudDialog>
    <DialogContent>
        <MudForm Model="@Model" @ref="@_form" Validation="@(Validator.ValidateValue(Model))">
            <MudGrid Spacing="2">
                <MudItem xs="12">
                    <MudText Typo="Typo.h6" Class="mb-2">@L["Personal Information"]</MudText>
                </MudItem>
                <MudItem xs="12" sm="4">
                    <MudTextField Label="@L["First Name"]" @bind-Value="Model.FirstName" For="@(() => Model.FirstName)" Required="true" />
                </MudItem>
                <MudItem xs="12" sm="4">
                    <MudTextField Label="@L["Middle Name"]" @bind-Value="Model.MiddleName" For="@(() => Model.MiddleName)" />
                </MudItem>
                <MudItem xs="12" sm="4">
                    <MudTextField Label="@L["Last Name"]" @bind-Value="Model.LastName" For="@(() => Model.LastName)" Required="true" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField Label="@L["First Name (Arabic)"]" @bind-Value="Model.FirstNameArabic" For="@(() => Model.FirstNameArabic)" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField Label="@L["Last Name (Arabic)"]" @bind-Value="Model.LastNameArabic" For="@(() => Model.LastNameArabic)" />
                </MudItem>
                <MudItem xs="12" sm="4">
                    <MudDatePicker Label="@L["Date of Birth"]" 
                                   Date="Model.DateOfBirth" 
                                   DateChanged="EventCallback.Factory.Create<DateTime?>(this, value => Model.DateOfBirth = value ?? DateTime.Now)" />
                </MudItem>
                <MudItem xs="12" sm="4">
                    <PicklistAutocomplete Picklist="Picklist.Gender" T="string" Label="@L["Gender"]" @bind-Value="Model.Gender" For="@(() => Model.Gender)" />
                </MudItem>
                <MudItem xs="12" sm="4">
                    <MudSelect T="int?" Label="@L["Blood Group"]" @bind-Value="Model.BloodGroupId" For="@(() => Model.BloodGroupId)">
                        <MudSelectItem T="int?" Value="null">@L["None"]</MudSelectItem>
                        @foreach (var item in _bloodGroups)
                        {
                            <MudSelectItem T="int?" Value="@item.Id">@item.Name</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" sm="4">
                    <MudSelect T="int?" Label="@L["Marital Status"]" @bind-Value="Model.MaritalStatusId" For="@(() => Model.MaritalStatusId)">
                        <MudSelectItem T="int?" Value="null">@L["None"]</MudSelectItem>
                        @foreach (var item in _maritalStatuses)
                        {
                            <MudSelectItem T="int?" Value="@item.Id">@item.Name</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" sm="4">
                    <MudSelect T="int?" Label="@L["Nationality"]" @bind-Value="Model.NationalityId" For="@(() => Model.NationalityId)">
                        <MudSelectItem T="int?" Value="null">@L["None"]</MudSelectItem>
                        @foreach (var item in _nationalities)
                        {
                            <MudSelectItem T="int?" Value="@item.Id">@item.Name</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" sm="4">
                    <MudCheckBox Label="@L["Is VIP"]" @bind-Value="Model.IsVIP" For="@(() => Model.IsVIP)" />
                </MudItem>

                <MudItem xs="12">
                    <MudText Typo="Typo.h6" Class="mb-2 mt-4">@L["Identity Documents"]</MudText>
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField Label="@L["Emirates ID"]" @bind-Value="Model.EmiratesId" For="@(() => Model.EmiratesId)" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField Label="@L["Passport Number"]" @bind-Value="Model.PassportNumber" For="@(() => Model.PassportNumber)" />
                </MudItem>

                <MudItem xs="12">
                    <MudText Typo="Typo.h6" Class="mb-2 mt-4">@L["Contact Information"]</MudText>
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField Label="@L["Phone"]" @bind-Value="Model.Phone" For="@(() => Model.Phone)" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField Label="@L["Email"]" @bind-Value="Model.Email" For="@(() => Model.Email)" />
                </MudItem>
                <MudItem xs="12">
                    <MudTextField Label="@L["Address"]" @bind-Value="Model.Address" For="@(() => Model.Address)" Lines="2" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudSelect T="int?" Label="@L["Country"]" Value="@Model.CountryId" ValueChanged="OnCountryChanged" For="@(() => Model.CountryId)">
                        <MudSelectItem T="int?" Value="null">@L["None"]</MudSelectItem>
                        @foreach (var item in _countries)
                        {
                            <MudSelectItem T="int?" Value="@item.Id">@item.Name</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudSelect T="int?" Label="@L["City"]" @bind-Value="Model.CityId" For="@(() => Model.CityId)" Disabled="@(Model.CountryId == null)">
                        <MudSelectItem T="int?" Value="null">@L["None"]</MudSelectItem>
                        @foreach (var item in _filteredCities)
                        {
                            <MudSelectItem T="int?" Value="@item.Id">@item.Name</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>

                <MudItem xs="12">
                    <MudText Typo="Typo.h6" Class="mb-2 mt-4">@L["Medical Record Number"]</MudText>
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField Label="@L["MRN"]" @bind-Value="Model.MRN" For="@(() => Model.MRN)" ReadOnly="@(Model.Id > 0)" Disabled="@(Model.Id > 0)" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudCheckBox Label="@L["Is Active"]" @bind-Value="Model.IsActive" For="@(() => Model.IsActive)" />
                </MudItem>
            </MudGrid>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">@ConstantString.Cancel</MudButton>
        <MudLoadingButton Loading="@_savingnew" OnClick="SaveAndNew">@ConstantString.SaveAndNew</MudLoadingButton>
        <MudLoadingButton Loading="@_saving" OnClick="Submit">@ConstantString.Save</MudLoadingButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] private IMudDialogInstance MudDialog { get; set; } = default!;
    [EditorRequired][Parameter] public AddEditPatientCommand Model { get; set; } = default!;
    [Parameter] public Action? Refresh { get; set; }
    private MudForm? _form;
    private bool _saving;
    private bool _savingnew;
    
    private IEnumerable<BloodGroupDto> _bloodGroups = new List<BloodGroupDto>();
    private IEnumerable<MaritalStatusDto> _maritalStatuses = new List<MaritalStatusDto>();
    private IEnumerable<NationalityDto> _nationalities = new List<NationalityDto>();
    private IEnumerable<CityDto> _cities = new List<CityDto>();
    private IEnumerable<CountryDto> _countries = new List<CountryDto>();
    private IEnumerable<CityDto> _filteredCities => Model.CountryId.HasValue 
        ? _cities.Where(c => c.CountryId == Model.CountryId.Value) 
        : Enumerable.Empty<CityDto>();

    protected override async Task OnInitializedAsync()
    {
        _bloodGroups = await Mediator.Send(new GetAllBloodGroupsQuery());
        _maritalStatuses = await Mediator.Send(new GetAllMaritalStatusesQuery());
        _nationalities = await Mediator.Send(new GetAllNationalitiesQuery());
        _cities = await Mediator.Send(new GetAllCitiesQuery());
        _countries = await Mediator.Send(new GetAllCountriesQuery());
    }

    private void OnCountryChanged(int? countryId)
    {
        Model.CountryId = countryId;
        if (Model.CityId.HasValue)
        {
            var city = _cities.FirstOrDefault(c => c.Id == Model.CityId.Value);
            if (city?.CountryId != countryId)
            {
                Model.CityId = null;
            }
        }
    }

    private async Task Submit()
    {
        _saving = true;
        try
        {
            await _form!.Validate().ConfigureAwait(false);
            if (!_form!.IsValid) return;
            var result = await Mediator.Send(Model);
            result.Match(
                data =>
                {
                    MudDialog.Close(DialogResult.Ok(true));
                    Snackbar.Add(ConstantString.SaveSuccess, Severity.Info);
                    return data;
                },
                errors =>
                {
                    Snackbar.Add(errors, Severity.Error);
                    return 0;
                });
        }
        finally
        {
            _saving = false;
        }
    }

    private async Task SaveAndNew()
    {
        _savingnew = true;
        try
        {
            await _form!.Validate().ConfigureAwait(false);
            if (!_form!.IsValid) return;
            var result = await Mediator.Send(Model);
            result.Match(
                data =>
                {
                    Snackbar.Add(ConstantString.SaveSuccess, Severity.Info);
                    Refresh?.Invoke();
                    Model = new AddEditPatientCommand();
                    return data;
                },
                errors =>
                {
                    Snackbar.Add(result.ErrorMessage, Severity.Error);
                    return 0;
                });
        }
        finally
        {
            _savingnew = false;
        }
    }

    private void Cancel() => MudDialog.Cancel();
}
