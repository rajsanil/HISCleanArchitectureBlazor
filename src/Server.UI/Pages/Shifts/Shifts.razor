@page "/pages/shifts"
@using CleanArchitecture.Blazor.Application.Features.Shifts.DTOs
@using CleanArchitecture.Blazor.Application.Features.Shifts.Queries.GetAll
@using CleanArchitecture.Blazor.Application.Features.Shifts.Caching
@using CleanArchitecture.Blazor.Application.Features.Shifts.Commands.AddEdit
@using CleanArchitecture.Blazor.Application.Features.Shifts.Commands.Delete

@inject IStringLocalizer<Shifts> L

<PageTitle>@Title</PageTitle>

<MudPaper Elevation="0" Class="pa-4">
    @* -- Header Toolbar -- *@
    <MudStack Row Spacing="0" Class="mb-3" Justify="Justify.SpaceBetween">
        <MudStack Row AlignItems="AlignItems.Center">
            <MudIcon Icon="@Icons.Material.Filled.Schedule" Size="Size.Large" Color="Color.Primary" />
            <MudStack Spacing="0">
                <MudText Typo="Typo.h6">@Title</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">Manage work shifts and schedules</MudText>
            </MudStack>
        </MudStack>
        <MudStack Row Spacing="1" AlignItems="AlignItems.Center" Class="flex-wrap">
            @if (_canSearch)
            {
                <MudTextField T="string"
                              Value="@_searchString"
                              ValueChanged="@OnSearch"
                              Placeholder="@ConstantString.Search"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Search"
                              IconSize="Size.Small"
                              Class="mt-0"
                              Style="min-width:200px;" />
            }
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Default"
                       StartIcon="@Icons.Material.Outlined.Refresh"
                       OnClick="OnRefresh"
                       Disabled="@_loading">
                @ConstantString.Refresh
            </MudButton>
            @if (_canCreate)
            {
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           StartIcon="@Icons.Material.Outlined.Add"
                           OnClick="OnCreate">
                    @ConstantString.New
                </MudButton>
            }
            @if (_canCreate)
            {
                <MudButton Variant="Variant.Outlined"
                           Color="Color.Primary"
                           StartIcon="@Icons.Material.Outlined.ContentCopy"
                           OnClick="OnClone"
                           Disabled="@(_selectedItems?.Count() != 1)">
                    @ConstantString.Clone
                </MudButton>
            }
            @if (_canDelete)
            {
                <MudButton Variant="Variant.Outlined"
                           Color="Color.Error"
                           StartIcon="@Icons.Material.Outlined.Delete"
                           OnClick="OnDeleteChecked"
                           Disabled="@(!(_selectedItems?.Any() ?? false))">
                    @ConstantString.Delete (@(_selectedItems?.Count() ?? 0))
                </MudButton>
            }
        </MudStack>
    </MudStack>

    @* -- Telerik Data Grid -- *@
    <div class="telerik-grid-container">
        <TelerikGrid Data="@_filteredItems"
                     Pageable="true"
                     PageSize="@_pageSize"
                     @bind-Page="@_currentPage"
                     Sortable="true"
                     SortMode="@Telerik.Blazor.SortMode.Multiple"
                     FilterMode="@GridFilterMode.FilterRow"
                     Resizable="true"
                     Reorderable="true"
                     SelectionMode="@GridSelectionMode.Multiple"
                     @bind-SelectedItems="@_selectedItems"
                     Height="calc(100vh - 340px)"
                     OnRowDoubleClick="@OnRowDoubleClick">
            <GridColumns>
                <GridCheckboxColumn Width="50px" SelectAll="true" />
                <GridColumn Field="@nameof(ShiftDto.ShiftCode)"
                            Title="Code"
                            Width="150px" />
                <GridColumn Field="@nameof(ShiftDto.ShiftName)"
                            Title="Name"
                            Width="250px" />
                <GridColumn Field="@nameof(ShiftDto.FromTime)"
                            Title="From Time"
                            Width="150px">
                    <Template>
                        @{
                            var item = (ShiftDto)context;
                        }
                        <span>@FormatTime(item.FromTime)</span>
                    </Template>
                </GridColumn>
                <GridColumn Field="@nameof(ShiftDto.ToTime)"
                            Title="To Time"
                            Width="150px">
                    <Template>
                        @{
                            var item = (ShiftDto)context;
                        }
                        <span>@FormatTime(item.ToTime)</span>
                    </Template>
                </GridColumn>
                <GridColumn Field="@nameof(ShiftDto.IsActive)"
                            Title="Active"
                            Width="110px"
                            TextAlign="@ColumnTextAlign.Center">
                    <Template>
                        @{
                            var item = (ShiftDto)context;
                        }
                        <MudChip T="string" Size="Size.Small"
                                 Color="@(item.IsActive ? Color.Success : Color.Default)"
                                 Variant="Variant.Filled">
                            @(item.IsActive ? "Active" : "Inactive")
                        </MudChip>
                    </Template>
                </GridColumn>
                <GridColumn Title="@ConstantString.Actions"
                            Width="120px"
                            Filterable="false"
                            Sortable="false"
                            TextAlign="@ColumnTextAlign.Center">
                    <Template>
                        @{
                            var item = (ShiftDto)context;
                        }
                        @if (_canEdit)
                        {
                            <MudIconButton Icon="@Icons.Material.Outlined.Edit"
                                           Size="Size.Small"
                                           Color="Color.Primary"
                                           OnClick="@(() => OnEdit(item))"
                                           Title="@ConstantString.Edit" />
                        }
                        @if (_canDelete)
                        {
                            <MudIconButton Icon="@Icons.Material.Outlined.Delete"
                                           Size="Size.Small"
                                           Color="Color.Error"
                                           OnClick="@(() => OnDelete(item))"
                                           Title="@ConstantString.Delete" />
                        }
                    </Template>
                </GridColumn>
            </GridColumns>
        </TelerikGrid>
    </div>
</MudPaper>

@* -- Telerik Window: Shift Form -- *@
<TelerikWindow @bind-Visible="@_formVisible"
               Modal="true"
               Width="600px"
               Class="shift-form-window">
    <WindowTitle>
        <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
            <MudIcon Icon="@Icons.Material.Filled.Schedule" Color="Color.Primary" />
            <MudText Typo="Typo.h6">@_formTitle</MudText>
        </MudStack>
    </WindowTitle>
    <WindowActions>
        <WindowAction Name="Close" />
    </WindowActions>
    <WindowContent>
        @if (_editModel is not null)
        {
            <MudForm @ref="_form" Model="@_editModel">
                <MudGrid Spacing="3" Class="pa-2">
                    <MudItem xs="12" sm="6">
                        <MudTextField @ref="_codeField"
                                      Label="Shift Code"
                                      @bind-Value="_editModel.ShiftCode"
                                      Required="true"
                                      Variant="Variant.Outlined"
                                      Error="@_fieldErrors.ContainsKey("ShiftCode")"
                                      ErrorText="@GetFieldError("ShiftCode")" />
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudTextField @ref="_nameField"
                                      Label="Shift Name"
                                      @bind-Value="_editModel.ShiftName"
                                      Required="true"
                                      Variant="Variant.Outlined"
                                      Error="@_fieldErrors.ContainsKey("ShiftName")"
                                      ErrorText="@GetFieldError("ShiftName")" />
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudTimePicker Label="From Time"
                                       @bind-Time="_fromTime"
                                       TimeFormat="HH:mm"
                                       Required="true"
                                       Variant="Variant.Outlined"
                                       AmPm="false" />
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudTimePicker Label="To Time"
                                       @bind-Time="_toTime"
                                       TimeFormat="HH:mm"
                                       Required="true"
                                       Variant="Variant.Outlined"
                                       AmPm="false"
                                       Error="@_fieldErrors.ContainsKey("ToTime")"
                                       ErrorText="@GetFieldError("ToTime")" />
                    </MudItem>
                    <MudItem xs="12" sm="6" Class="d-flex align-center">
                        <MudCheckBox Label="Is Active"
                                     @bind-Value="_editModel.IsActive"
                                     Color="Color.Primary" />
                    </MudItem>
                </MudGrid>
            </MudForm>

            <MudStack Row Spacing="2" Justify="Justify.FlexEnd" Class="pa-2 mt-2">
                <MudButton Variant="Variant.Text"
                           Color="Color.Default"
                           OnClick="CloseForm">
                    @ConstantString.Cancel
                </MudButton>
                <MudLoadingButton Variant="Variant.Outlined"
                                  Color="Color.Primary"
                                  Loading="@_savingNew"
                                  OnClick="SaveAndNew">
                    @ConstantString.SaveAndNew
                </MudLoadingButton>
                <MudLoadingButton Variant="Variant.Filled"
                                  Color="Color.Primary"
                                  Loading="@_saving"
                                  OnClick="SubmitForm">
                    @ConstantString.Save
                </MudLoadingButton>
            </MudStack>
        }
    </WindowContent>
</TelerikWindow>

@code {
    [CascadingParameter] private Task<AuthenticationState> AuthState { get; set; } = default!;
    [CascadingParameter] private UserProfile? UserProfile { get; set; }

    // -- Grid state --
    public string? Title { get; private set; }
    private List<ShiftDto> _allShifts = new();
    private List<ShiftDto> _filteredItems = new();
    private IEnumerable<ShiftDto> _selectedItems { get; set; } = new List<ShiftDto>();
    private bool _loading;
    private int _pageSize = 15;
    private int _currentPage = 1;
    private string _searchString = string.Empty;

    // -- Permissions --
    private bool _canSearch = true;
    private bool _canCreate = true;
    private bool _canEdit = true;
    private bool _canDelete = true;

    // -- Form state --
    private bool _formVisible;
    private string _formTitle = string.Empty;
    private AddEditShiftCommand? _editModel;
    private MudForm? _form;
    private bool _saving;
    private bool _savingNew;
    private TimeSpan? _fromTime;
    private TimeSpan? _toTime;

    // -- Field error state --
    private Dictionary<string, string> _fieldErrors = new();
    private MudTextField<string>? _codeField;
    private MudTextField<string>? _nameField;

    protected override async Task OnInitializedAsync()
    {
        Title = "Shifts";
        await LoadData();
    }

    private async Task LoadData()
    {
        _loading = true;
        try
        {
            var result = await Mediator.Send(new GetAllShiftsQuery());
            _allShifts = result.ToList();
            ApplySearch();
        }
        finally
        {
            _loading = false;
        }
    }

    private void ApplySearch()
    {
        _filteredItems = string.IsNullOrWhiteSpace(_searchString)
            ? _allShifts.ToList()
            : _allShifts.Where(x =>
                x.ShiftName.Contains(_searchString, StringComparison.OrdinalIgnoreCase) ||
                x.ShiftCode.Contains(_searchString, StringComparison.OrdinalIgnoreCase)
            ).ToList();
    }

    private void OnSearch(string text)
    {
        _searchString = text;
        ApplySearch();
    }

    private async Task OnRefresh()
    {
        ShiftCacheKey.Refresh();
        _selectedItems = new List<ShiftDto>();
        _searchString = string.Empty;
        await LoadData();
    }

    private void OnRowDoubleClick(GridRowClickEventArgs args)
    {
        if (_canEdit && args.Item is ShiftDto dto)
        {
            OnEdit(dto);
        }
    }

    // -- CRUD Operations --

    private void OnCreate()
    {
        ClearFieldErrors();
        _editModel = new AddEditShiftCommand();
        _fromTime = TimeSpan.FromHours(9); // Default 9:00 AM
        _toTime = TimeSpan.FromHours(17); // Default 5:00 PM
        _formTitle = string.Format(ConstantString.CreateAnItem, "Shift");
        _formVisible = true;
    }

    private void OnClone()
    {
        var copy = _selectedItems.FirstOrDefault();
        if (copy is null) return;
        ClearFieldErrors();
        _editModel = new AddEditShiftCommand
        {
            ShiftCode = copy.ShiftCode,
            ShiftName = copy.ShiftName,
            FromTime = copy.FromTime,
            ToTime = copy.ToTime,
            IsActive = copy.IsActive
        };
        _fromTime = copy.FromTime;
        _toTime = copy.ToTime;
        _formTitle = string.Format(ConstantString.CreateAnItem, "Shift");
        _formVisible = true;
    }

    private void OnEdit(ShiftDto dto)
    {
        ClearFieldErrors();
        _editModel = new AddEditShiftCommand
        {
            Id = dto.Id,
            ShiftCode = dto.ShiftCode,
            ShiftName = dto.ShiftName,
            FromTime = dto.FromTime,
            ToTime = dto.ToTime,
            IsActive = dto.IsActive
        };
        _fromTime = dto.FromTime;
        _toTime = dto.ToTime;
        _formTitle = string.Format(ConstantString.EditTheItem, "Shift");
        _formVisible = true;
    }

    private async Task OnDelete(ShiftDto dto)
    {
        var contentText = string.Format(ConstantString.DeleteConfirmation, dto.ShiftName);
        var command = new DeleteShiftCommand { Id = new[] { dto.Id } };
        await DialogServiceHelper.ShowDeleteConfirmationDialogAsync(command, ConstantString.DeleteConfirmationTitle, contentText, async () =>
        {
            await InvokeAsync(async () =>
            {
                await LoadData();
                _selectedItems = new List<ShiftDto>();
            });
        });
    }

    private async Task OnDeleteChecked()
    {
        var selected = _selectedItems.ToList();
        if (!selected.Any()) return;
        var contentText = string.Format(ConstantString.DeleteConfirmWithSelected, selected.Count);
        var command = new DeleteShiftCommand { Id = selected.Select(x => x.Id).ToArray() };
        await DialogServiceHelper.ShowDeleteConfirmationDialogAsync(command, ConstantString.DeleteConfirmationTitle, contentText, async () =>
        {
            await InvokeAsync(async () =>
            {
                await LoadData();
                _selectedItems = new List<ShiftDto>();
            });
        });
    }

    // -- Form Actions --

    private async Task SubmitForm()
    {
        if (_editModel is null) return;
        _saving = true;
        try
        {
            ClearFieldErrors();
            
            // Update model with time picker values
            if (_fromTime.HasValue) _editModel.FromTime = _fromTime.Value;
            if (_toTime.HasValue) _editModel.ToTime = _toTime.Value;

            await _form!.Validate();
            if (!_form!.IsValid) return;

            var result = await Mediator.Send(_editModel);
            result.Match(
                data =>
                {
                    _formVisible = false;
                    Snackbar.Add(ConstantString.SaveSuccess, Severity.Info);
                    return data;
                },
                errors =>
                {
                    var (fieldName, cleanMessage) = ParseFieldError(errors);
                    if (!string.IsNullOrEmpty(fieldName))
                    {
                        SetFieldError(fieldName, cleanMessage);
                    }
                    Snackbar.Add(cleanMessage, Severity.Error);
                    return 0;
                });
            await LoadData();
            _selectedItems = new List<ShiftDto>();
        }
        finally
        {
            _saving = false;
        }
    }

    private async Task SaveAndNew()
    {
        if (_editModel is null) return;
        _savingNew = true;
        try
        {
            ClearFieldErrors();

            // Update model with time picker values
            if (_fromTime.HasValue) _editModel.FromTime = _fromTime.Value;
            if (_toTime.HasValue) _editModel.ToTime = _toTime.Value;

            await _form!.Validate();
            if (!_form!.IsValid) return;

            var result = await Mediator.Send(_editModel);
            result.Match(
                data =>
                {
                    Snackbar.Add(ConstantString.SaveSuccess, Severity.Info);
                    _editModel = new AddEditShiftCommand();
                    _fromTime = TimeSpan.FromHours(9);
                    _toTime = TimeSpan.FromHours(17);
                    ClearFieldErrors();
                    return data;
                },
                errors =>
                {
                    var (fieldName, cleanMessage) = ParseFieldError(errors);
                    if (!string.IsNullOrEmpty(fieldName))
                    {
                        SetFieldError(fieldName, cleanMessage);
                    }
                    Snackbar.Add(cleanMessage, Severity.Error);
                    return 0;
                });
            await LoadData();
        }
        finally
        {
            _savingNew = false;
        }
    }

    private void CloseForm()
    {
        ClearFieldErrors();
        _formVisible = false;
        _editModel = null;
    }

    // -- Field Error Helpers --

    private (string fieldName, string message) ParseFieldError(string? error)
    {
        if (string.IsNullOrEmpty(error)) return (string.Empty, error ?? string.Empty);
        var idx = error.IndexOf('|');
        if (idx > 0)
            return (error[..idx], error[(idx + 1)..]);
        return (string.Empty, error);
    }

    private string GetFieldError(string fieldName)
        => _fieldErrors.TryGetValue(fieldName, out var msg) ? msg : string.Empty;

    private void ClearFieldErrors()
        => _fieldErrors.Clear();

    private void SetFieldError(string fieldName, string message)
    {
        _fieldErrors[fieldName] = message;
        _ = Task.Run(async () =>
        {
            await Task.Delay(100);
            await InvokeAsync(() =>
            {
                if (fieldName == "ShiftCode") _codeField?.FocusAsync();
                else if (fieldName == "ShiftName") _nameField?.FocusAsync();
                StateHasChanged();
            });
        });
    }

    private string FormatTime(TimeSpan time)
    {
        return $"{time.Hours:D2}:{time.Minutes:D2}";
    }
}
