@page "/pages/countries"
@using CleanArchitecture.Blazor.Application.Features.Countries.DTOs
@using CleanArchitecture.Blazor.Application.Features.Countries.Queries.GetAll
@using CleanArchitecture.Blazor.Application.Features.Countries.Commands.AddEdit
@using CleanArchitecture.Blazor.Application.Features.Countries.Commands.Delete
@using CleanArchitecture.Blazor.Application.Features.Countries.Caching
@using CleanArchitecture.Blazor.Application.Features.Countries.Mappers
@using CleanArchitecture.Blazor.Server.UI.Pages.Countries.Components

@inject IStringLocalizer<Countries> L
@attribute [Authorize(Policy = Permissions.Countries.View)]

<PageTitle>@L["Countries"]</PageTitle>

<MudPaper Elevation="0" Class="pa-4">
    <TelerikGrid Data="@_countries"
                 FilterMode="GridFilterMode.FilterMenu"
                 Sortable="true"
                 Pageable="true"
                 PageSize="15"
                 Resizable="true"
                 Reorderable="true"
                 SelectionMode="GridSelectionMode.Single"
                 @bind-SelectedItems="@_selectedItems"
                 Height="calc(100vh - 300px)">
        <GridToolBarTemplate>
            <MudStack Row Spacing="2" Class="flex-grow-1" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                <MudStack Row AlignItems="AlignItems.Center">
                    <MudIcon Icon="@Icons.Material.Filled.Public" Size="Size.Large" Color="Color.Success" />
                    <MudStack Spacing="0">
                        <MudText Typo="Typo.h6">@L["Countries"]</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">@L["Manage countries"]</MudText>
                    </MudStack>
                </MudStack>
                <MudStack Row Spacing="1">
                    <MudButton Disabled="@_loading"
                               OnClick="@OnRefresh"
                               StartIcon="@Icons.Material.Outlined.Refresh"
                               Variant="Variant.Text">
                        @ConstantString.Refresh
                    </MudButton>
                    @if (_canCreate)
                    {
                        <MudButton StartIcon="@Icons.Material.Outlined.Add"
                                   OnClick="OnCreate"
                                   Color="Color.Primary"
                                   Variant="Variant.Filled">
                            @ConstantString.New
                        </MudButton>
                    }
                </MudStack>
            </MudStack>
        </GridToolBarTemplate>
        <GridColumns>
            <GridColumn Width="100px" Title="@ConstantString.Actions" Sortable="false" Filterable="false">
                <Template>
                    @{
                        var item = context as CountryDto;
                        @if (_canEdit || _canDelete)
                        {
                            <MudStack Row Spacing="1">
                                @if (_canEdit)
                                {
                                    <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                                 Size="Size.Small" 
                                                 Color="Color.Info"
                                                 OnClick="@(() => OnEdit(item!))" />
                                }
                                @if (_canDelete)
                                {
                                    <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                                 Size="Size.Small" 
                                                 Color="Color.Error"
                                                 OnClick="@(() => OnDelete(item!))" />
                                }
                            </MudStack>
                        }
                        else
                        {
                            <MudIconButton Variant="Variant.Filled"
                                         Disabled="true"
                                         Icon="@Icons.Material.Filled.DoNotTouch"
                                         Size="Size.Small"
                                         Color="Color.Surface">
                            </MudIconButton>
                        }
                    }
                </Template>
            </GridColumn>
            <GridColumn Field="@nameof(CountryDto.Code)" Title="@L["Code"]" Width="120px" />
            <GridColumn Field="@nameof(CountryDto.Name)" Title="@L["Name"]" />
            <GridColumn Field="@nameof(CountryDto.NameArabic)" Title="@L["Name (Arabic)"]" />
            <GridColumn Field="@nameof(CountryDto.Iso2Code)" Title="@L["ISO2"]" Width="100px" />
            <GridColumn Field="@nameof(CountryDto.Iso3Code)" Title="@L["ISO3"]" Width="100px" />
            <GridColumn Field="@nameof(CountryDto.PhoneCode)" Title="@L["Phone Code"]" Width="120px" />
            <GridColumn Field="@nameof(CountryDto.IsActive)" Title="@L["Active"]" Width="100px">
                <Template>
                    @{
                        var item = context as CountryDto;
                        <MudCheckBox T="bool" Value="@(item?.IsActive ?? false)" ReadOnly="true" Color="Color.Primary" />
                    }
                </Template>
            </GridColumn>
        </GridColumns>
    </TelerikGrid>
</MudPaper>

@code {
    [CascadingParameter] private Task<AuthenticationState> AuthState { get; set; } = default!;
    
    private IEnumerable<CountryDto> _countries = new List<CountryDto>();
    private IEnumerable<CountryDto> _selectedItems = new List<CountryDto>();
    private bool _loading;
    private bool _canCreate;
    private bool _canEdit;
    private bool _canDelete;
    private bool _canSearch;
    private bool _canExport;
    private bool _canImport;

    protected override async Task OnInitializedAsync()
    {
        var state = await AuthState;
        _canCreate = (await AuthService.AuthorizeAsync(state.User, Permissions.Countries.Create)).Succeeded;
        _canSearch = (await AuthService.AuthorizeAsync(state.User, Permissions.Countries.Search)).Succeeded;
        _canEdit = (await AuthService.AuthorizeAsync(state.User, Permissions.Countries.Edit)).Succeeded;
        _canDelete = (await AuthService.AuthorizeAsync(state.User, Permissions.Countries.Delete)).Succeeded;
        _canImport = (await AuthService.AuthorizeAsync(state.User, Permissions.Countries.Import)).Succeeded;
        _canExport = (await AuthService.AuthorizeAsync(state.User, Permissions.Countries.Export)).Succeeded;
        await LoadData();
    }

    private async Task LoadData()
    {
        _loading = true;
        try
        {
            _countries = await Mediator.Send(new GetAllCountriesQuery());
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task OnRefresh()
    {
        CountryCacheKey.Refresh();
        await LoadData();
    }

    private async Task OnCreate()
    {
        var command = new AddEditCountryCommand();
        await ShowEditFormDialog(string.Format(ConstantString.CreateAnItem, L["Country"]), command);
    }

    private async Task OnEdit(CountryDto dto)
    {
        var command = CountryMapper.CloneFromDto(dto);
        await ShowEditFormDialog(string.Format(ConstantString.EditTheItem, L["Country"]), command);
    }

    private async Task OnDelete(CountryDto dto)
    {
        var contentText = string.Format(ConstantString.DeleteConfirmation, dto.Name);
        var command = new DeleteCountryCommand(new int[] { dto.Id });
        await DialogServiceHelper.ShowDeleteConfirmationDialogAsync(command, ConstantString.DeleteConfirmationTitle, contentText, async () =>
        {
            await InvokeAsync(async () =>
            {
                await LoadData();
            });
        });
    }

    private async Task ShowEditFormDialog(string title, AddEditCountryCommand command)
    {
        var parameters = new DialogParameters<CountryFormDialog>
        {
            { x => x.Model, command }
        };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = await DialogService.ShowAsync<CountryFormDialog>(title, parameters, options);
        var state = await dialog.Result;

        if (state != null && !state.Canceled)
        {
            await LoadData();
        }
    }
}

