@using CleanArchitecture.Blazor.Server.UI.Models.NavigationMenu
@using CleanArchitecture.Blazor.Server.UI.Services.Navigation
@using PageStatus = CleanArchitecture.Blazor.Server.UI.Models.NavigationMenu.PageStatus
@inject IMenuService MenuService
@inject LayoutService LayoutService
@inject IStringLocalizer<NavigationMenu> L

<MudDrawer Breakpoint="Breakpoint.Md"
           Class="side-menu"
           Elevation="0"
           Open="DrawerOpen"
           OpenChanged="@(e => DrawerOpenChanged.InvokeAsync(e))"
           Variant="DrawerVariant.Responsive">
    <MudDrawerHeader Class="align-center d-flex align-center pa-0" Style="min-height: 64px;">
        <MudIcon Class="ml-5 mr-2"
                 Color="Color.Primary"
                 Icon="@Icons.Material.Filled.LocalHospital"
                 Size="Size.Large"/>
        <MudText Typo="Typo.h6" Class="brand-text">
            Blazor<span class="brand-accent">HIS</span>
        </MudText>
    </MudDrawerHeader>

    <MudNavMenu Class="px-3">
        @foreach (var section in MenuSections.Where(x => IsVisible(x.Permission, x.Roles)))
        {
            @if (section is not null)
            {
                <div class="mt-4 mb-2 px-3">
                    <MudText Typo="Typo.overline" Class="nav-section-title">
                        @(L[section.Title])
                    </MudText>
                </div>


                @if (section.SectionItems is not null)
                {
                    @foreach (var sectionItem in section.SectionItems.Where(x => IsVisible(x.Permission, x.Roles)))
                    {
                        @if (sectionItem is { IsParent: true, MenuItems: not null })
                        {
                            <MudNavGroup Icon="@sectionItem.Icon" Title="@L[sectionItem.Title]" Expanded="Expanded(sectionItem)" Class="nav-group-medex">
                                @foreach (var menuItem in sectionItem.MenuItems.Where(x => IsVisible(x.Permission, x.Roles)))
                                {
                                    <MudNavLink Disabled="@(menuItem.PageStatus != PageStatus.Completed)" Href="@(menuItem.Href)" Target="@(menuItem.Target)" Match="NavLinkMatch.Prefix">
                                        <div class="d-flex">
                                            @(L[menuItem.Title])
                                            @if (menuItem.PageStatus != PageStatus.Completed)
                                            {
                                                <MudSpacer/>
                                                <MudChip T="string" Class="mr-4" Color="@Color.Primary" Size="Size.Small" Variant="Variant.Text">
                                                    @(L[menuItem.PageStatus.GetDescription()])
                                                </MudChip>
                                            }
                                        </div>
                                    </MudNavLink>
                                }
                            </MudNavGroup>
                        }
                        else
                        {
                            <MudNavLink Disabled="@(sectionItem.PageStatus != PageStatus.Completed)" Href="@(sectionItem.Href)" Icon="@(sectionItem.Icon)" Target="@(sectionItem.Target)" Match="NavLinkMatch.All">
                                <div class="d-flex">
                                    @(L[sectionItem.Title])
                                    @if (sectionItem.PageStatus != PageStatus.Completed)
                                    {
                                        <MudSpacer/>
                                        <MudChip T="string" Class="mr-4" Color="@Color.Primary" Size="Size.Small" Variant="Variant.Text">
                                            @(L[sectionItem.PageStatus.GetDescription()])
                                        </MudChip>
                                    }
                                </div>
                            </MudNavLink>
                        }
                    }
                }
            }
        }
    </MudNavMenu>

    <MudSpacer />
    <MudDivider Class="mx-3"></MudDivider>
    <MudNavMenu Class="d-flex justify-space-between pa-4">
        <MudLink Href="#" Style="font-size:0.625rem;line-height:1.125rem;color:#9CA3AF !important">@L[ApplicationSettings.Copyright]</MudLink>
        <MudText Style="font-size:0.625rem;line-height:1.125rem;color:#9CA3AF !important">@L["version"] @ApplicationSettings.Version</MudText>
    </MudNavMenu>

</MudDrawer>

<style>
    /* MedEx-style active navigation link — pill shape */
    .side-menu .mud-nav-link.active:not(.mud-nav-link-disabled) {
        background-color: var(--mud-palette-primary) !important;
        color: #ffffff !important;
        border-radius: 10px !important;
        border: none !important;
        margin: 2px 0;
    }

    .side-menu .mud-nav-link.active:not(.mud-nav-link-disabled) .mud-icon-root {
        color: #ffffff !important;
    }

    .side-menu .mud-nav-link.active:not(.mud-nav-link-disabled) .mud-nav-link-text {
        color: #ffffff !important;
    }

    .side-menu .mud-nav-link:not(.active):hover {
        background-color: rgba(var(--mud-palette-primary-rgb), 0.08) !important;
        border-radius: 10px !important;
    }

    .side-menu {
        border-right: 1px solid var(--mud-palette-table-lines);
    }
</style>

@code
{
    [CascadingParameter] private Task<AuthenticationState> AuthState { get; set; } = default!;
    [EditorRequired] [Parameter] public EventCallback<bool> DrawerOpenChanged { get; set; }

    [EditorRequired] [Parameter] public bool DrawerOpen { get; set; }

    private IEnumerable<MenuSectionModel> MenuSections => MenuService.Features;
    [EditorRequired] [Parameter] public string[] Roles { get; set; } = Array.Empty<string>();
    [EditorRequired] [Parameter] public HashSet<string> Permissions { get; set; } = new();

    /// <summary>
    /// Determines menu item visibility. Permission-based check takes precedence over role-based check.
    /// </summary>
    private bool IsVisible(string? permission, string[]? roles)
    {
        if (!string.IsNullOrEmpty(permission))
            return Permissions.Contains(permission);
        return roles == null || roles.Any(r => Roles.Contains(r));
    }

    private bool Expanded(MenuSectionItemModel menu)
    {
        var href = Navigation.Uri[(Navigation.BaseUri.Length - 1)..];
        return menu is { IsParent: true, MenuItems: not null } &&
               menu.MenuItems.Any(x => !string.IsNullOrEmpty(x.Href) && href.Contains(x.Href));
    }

}